# 선수 레이팅 정밀 튜닝 (Phase 1-4)

> 1차 AI 벌크 생성(`rating-generation.md`) 이후 실제 NBA 스탯 기반으로 632명의 능력치를 정밀 교정한 프로세스

---

## 1. 배경: 왜 튜닝이 필요했나

1차 생성(Claude AI 벌크)은 선수당 35개 속성을 NBA 지식 기반으로 한 번에 생성했다.
결과적으로 포지션별 분포는 합리적이었으나, **개별 선수 단위**에서 반복적인 오류 패턴이 발견됨:

| 문제 유형 | 예시 |
|-----------|------|
| `mid` 전반 과대 | 벤치급 선수에게도 97(Mr.Fundamental 트리거) 부여 |
| `close`/`lay` 전반 과대 | 림 FG% 60%대 선수에 95+ |
| `intangibles` 인플레 | 비우승 벤치급에 95+ (Closer 아키타입 남발) |
| `siq` 인플레 | TS% 56%대에 90+ |
| `pdef` 빅맨 과대 | 비스위치 센터에 85+ (페리미터 수비) |
| `stl` 전반 과소 | 실제 SPG/STL% 대비 낮게 책정 |
| `ft` 실제 FT%와 괴리 | 엔진이 `ft/100`을 직접 확률로 사용하므로 치명적 |
| 3PT 빅맨 과대 | 비슈터 C/PF에 70-85 3PT |

이 패턴들은 PBP 엔진(`hitRate += (off - def) * 0.002`)에 직접 영향을 주어 시뮬레이션 결과를 왜곡시킴.

---

## 2. 전체 프로세스 개요

```
Phase 1: 앵커 33명 (수동 리뷰)
  ├─ 슈퍼스타 10명   ← 웹 검색 + 24-25 시즌 스탯 기반
  ├─ 올스타 9명      ← 동일
  ├─ 레전드 9명      ← 피크 윈도우 통산/전성기 스탯 기반
  └─ 신규 추가 5명   ← CSV에 누락된 선수 INSERT
      ↓
Phase 2: 선발급 ~120명 (규칙 기반 자동 + 수동 교정)
  ├─ Python 스크립트 10가지 규칙 적용 → 94명 UPDATE
  └─ 오보정 22건 수동 교정
      ↓
Phase 3+4: 나머지 ~500명 (확장 규칙 자동 + 수동 교정)
  ├─ 확장 규칙(저OVR 추가 임계값) 적용 → 276명 UPDATE
  └─ 오보정 5건 수동 교정
      ↓
Phase 5: 시뮬레이션 검증 (사용자 직접 수행)
```

---

## 3. Phase 1: 앵커 선수 수동 리뷰 (33명)

### 3.1 방법론

**현역 (24-25 시즌 기준)**:
- 1차 소스: 24-25 레귤러시즌 스탯 (per-game + rate stats)
- 2차 소스: NBA.com 추적 데이터 (슛 존별 FG%, 수비 메트릭, 허슬 스탯)
- 3차 소스: Advanced stats (BPM, EPM, TS%) — 교차 검증용
- 안정화: 3년 가중평균 `(0.60 × 올시즌) + (0.25 × 작시즌) + (0.15 × 재작시즌)`
- 20경기 미만 선수: 커리어 데이터 50% 혼합

**올타임 레전드 (FA)**:
- 피크 윈도우: BPM+VORP 기준 최고 시즌 ±1년 (3년 피크)
- 시대 보정: pre-3점 시대 선수는 동시대 백분위 → 현대 분포 역변환
- 최종 공식: `legendRating = peakRating × 0.75 + careerAvg × 0.25`
- 상한: 현역 최상위보다 단일 능력치 5점 이상 초과 금지 (해당 스킬 역대 1인자만 예외)

### 3.2 리뷰 시트 형식

각 선수에 대해 현재값/제안값/근거를 테이블로 작성:

```
## 르브론 제임스 (SF, LAM) — 현역
24-25: 23.5/7.9/9.0, FG% 50.1%, 3PT% 33.0%, FT% 76.5%

| 능력치 | 현재 | 제안 | 근거 |
|--------|------|------|------|
| ft     | 82   | 78   | FT% 76.5% (엔진이 ft/100 직접 사용) |
| 3c     | 90   | 87   | 24-25 3PT% 33.0%, 하락 추세 |
| intangibles | 90 | 99 | 역대급 플레이오프 이력, 클러치 기록 |
```

### 3.3 앵커 선수 목록 (33명)

**슈퍼스타 10명**: 요키치, SGA, 야니스, 루카, 테이텀, 커리, KD, 엠비드, AD, 르브론

**올스타 9명**: 미첼, 에드워즈, 브라운, 할리버튼, 팍스, 트레이영, 아데바요, 웸반야마, 부커

**레전드 9명**: 조던, 샤킬, 코비, 던컨, 매직, 올라주원, 윌트, 카림, 웨이드

**신규 추가 5명** (CSV 누락): 래리 버드, 데미안 릴라드, 줄리어스 어빙, 스카티 피펜, 폴 피어스

### 3.4 Phase 1에서 발견한 공통 패턴

이 33명을 정밀 리뷰하면서 전체 데이터에 적용 가능한 **체계적 오류 패턴 10가지**를 도출함 → Phase 2 이후의 자동 보정 규칙으로 활용.

---

## 4. 자동 보정 규칙 (10가지)

Phase 1에서 발견한 패턴을 Python 스크립트로 규칙화하여 나머지 선수에 일괄 적용.

### 핵심 개념: Proxy OVR

규칙의 임계값 분기에 사용하는 간이 OVR:
```python
def compute_proxy_ovr(attrs):
    exclude = {"age", "height", "weight", "salary", "contractyears", "pot", "lock"}
    vals = [v for k, v in attrs.items() if k not in exclude and isinstance(v, (int, float))]
    return sum(vals) / len(vals)
```
`pot`, `lock`과 메타 필드를 제외한 모든 수치형 능력치의 산술 평균.

### 규칙 1: pdef 빅맨 보정

**문제**: C/PF에게 페리미터 수비(pdef) 80-92가 과대 부여. 전통 빅맨은 외곽 수비가 약점.

```
조건: is_big AND name NOT IN SWITCHABLE_BIGS
  pdef >= 88  → pdef = max(55, pdef - 15)
  pdef >= 82  → pdef = max(60, pdef - 10)
  pdef >= 78 AND proxy < 70  → pdef = max(58, pdef - 8)   [Phase 3+4 확장]
```

**예외 목록 (SWITCHABLE_BIGS)**: 아데바요, 모블리, 드레이먼드, 랜들, 시아캄, 반스, 웸반야마, 가넷, 바클리, 벤 월리스, 애런 고든, 허버트 존스, 쿠밍가

### 규칙 2: intangibles 보정

**문제**: 비챔피언 선수에게 90-98 intangibles 남발 → Closer 아키타입 과다 발동.

```
조건: name NOT IN CHAMPIONS
  intangibles >= 95:
    proxy >= 80 → 85
    proxy >= 75 → 78
    else        → 72
  intangibles >= 90 AND proxy < 78 → min(intang, 80)
  intangibles >= 85 AND proxy < 70 → min(intang, 75)   [Phase 3+4 확장]
  intangibles >= 80 AND proxy < 65 → min(intang, 70)   [Phase 3+4 확장]
```

**예외 목록 (CHAMPIONS)**: 우승/파이널MVP/MVP 이력이 있는 선수 ~45명. 이 선수들은 intangibles를 보호함. 주요: 카와이, 하든, 웨스트브룩, 가넷, 노비츠키, 파커, 지노빌리, 피어스, 레이 앨런, 아이버슨, 빌 러셀, 매직, 웨스트, 로즈(MVP), 타이리스 맥시(2024 챔), 파우 가솔(2x 챔) 등

### 규칙 3: mid 과대 보정

**문제**: `mid >= 97`은 Mr.Fundamental 아키타입 트리거. 실제 엘리트 미드레인지 슈터(조던, 코비, 듀란트 등)가 아닌 선수에 남발.

```
  mid >= 97:
    proxy < 82 → mid - 12
    else       → mid - 8
  mid >= 92:
    proxy < 78 → mid - 8
    proxy < 82 → mid - 5
  mid >= 88 AND proxy < 70 → mid - 6   [Phase 3+4 확장]
  mid >= 85 AND proxy < 65 → mid - 5   [Phase 3+4 확장]
```

### 규칙 4: close/lay 과대 보정

**문제**: 림 FG% 60-70%대 선수에 close/lay 95+ 부여.

```
close:
  >= 95: proxy < 80 → close - 10 | proxy < 83 → close - 5
  >= 90 AND proxy < 70 → close - 8   [Phase 3+4 확장]
  >= 85 AND proxy < 65 → close - 6   [Phase 3+4 확장]

lay:
  >= 95: proxy < 80 → lay - 8 | proxy < 83 → lay - 4
  >= 90 AND proxy < 70 → lay - 6   [Phase 3+4 확장]
  >= 85 AND proxy < 65 → lay - 5   [Phase 3+4 확장]
```

### 규칙 5: siq 과대 보정

**문제**: TS% 56-58%대 선수에 siq 90-98 부여.

```
  siq >= 95: proxy < 80 → siq - 15 | proxy < 83 → siq - 8
  siq >= 90 AND proxy < 78 → siq - 10
  siq >= 85 AND proxy < 70 → siq - 8   [Phase 3+4 확장]
  siq >= 80 AND proxy < 65 → siq - 6   [Phase 3+4 확장]
```

### 규칙 6: 3PT 비슈터 빅맨 보정

**문제**: 3PT를 쏘지 않는 C/PF에 3c/3_45/3t 68-85 부여.

```
조건: is_big AND name NOT IN GOOD_SHOOTERS AND name NOT IN WING_AS_PF
  3PT >= 75 → max(45, val - 12)
  3PT >= 68 → max(42, val - 8)
  3PT >= 62 AND proxy < 68 → max(40, val - 6)   [Phase 3+4 확장]
```

**예외 목록 (GOOD_SHOOTERS)**: 커리, 클레이, 레이 앨런, 밀러, 내쉬, 코버, 노비츠키, 버드, 릴라드, KAT, 쳇, 브룩 로페즈, 부체비치, 올리닉, 마르카넨, 모 바그너 등

**예외 목록 (WING_AS_PF)**: CSV에 PF로 등록되었지만 실제 윙인 선수 — 폴 조지, 위긴스, 버틀러, 제일런 존슨, 마일스 브리지스, 타리 이슨 등

### 규칙 7: stl 과소 보정

**문제**: 전반적으로 stl이 실제 SPG/STL% 대비 과소.

```
  proxy >= 76 AND stl <= 45 → stl + 8
  proxy >= 73 AND stl <= 40 → stl + 6
  proxy >= 68 AND stl <= 32 → stl + 5   [Phase 3+4 확장]
```

### 규칙 8: hus 과대 보정

**문제**: 허슬 스탯이 낮은 선수에게도 hus 90-99 부여.

```
  hus >= 95: proxy < 80 → hus - 8 | proxy < 83 → hus - 4
  hus >= 90 AND proxy < 72 → hus - 6   [Phase 3+4 확장]
  hus >= 85 AND proxy < 65 → hus - 5   [Phase 3+4 확장]
```

### 규칙 9: ocon 과대 보정

**문제**: 일관성 부족한 선수에게 ocon 90-98 부여.

```
  ocon >= 95 AND proxy < 80 → ocon - 10
  ocon >= 90 AND proxy < 70 → ocon - 8   [Phase 3+4 확장]
  ocon >= 85 AND proxy < 65 → ocon - 6   [Phase 3+4 확장]
```

### 규칙 10: draw 과대 보정

**문제**: FTA rate 낮은 선수에게 draw 90-98 부여.

```
  draw >= 95 AND proxy < 82 → draw - 10
  draw >= 90 AND proxy < 78 → draw - 8
  draw >= 85 AND proxy < 68 → draw - 6   [Phase 3+4 확장]
```

### 공통: 값 클램프

모든 보정 결과는 `max(40, min(99, value))`로 클램프.

---

## 5. 수동 교정 (오보정 수정)

규칙 기반 자동 보정의 한계로 인해 발생한 오보정을 수동으로 교정.

### 5.1 오보정 유형

| 유형 | 원인 | 건수 |
|------|------|------|
| 이름 불일치 | CSV 한글명 vs 예외 목록 한글명 다름 (촌시/챈시, 탐슨/톰슨, 마카넨/마르카넨) | 4건 |
| CHAMPIONS 누락 | 챔피언인데 목록에 빠짐 (맥시, 가솔, 홀리데이 등) | 3건 |
| 비슈터 레전드 siq | 슈팅이 약한 레전드의 proxyOVR이 낮아 siq 과도 하향 (빌 러셀, 벤 월리스) | 5건 |
| 엘리트 스코어러 | 특정 스킬이 역대급인 선수를 일반 규칙으로 하향 (카이리 mid, 노비츠키 mid, 드로잔 close) | 6건 |
| PF 윙 오분류 | CSV에 PF로 등록된 윙이 빅맨 3PT 규칙에 걸림 (폴 조지, 위긴스) | 4건 |
| 스위치 빅맨 누락 | SWITCHABLE_BIGS 목록에 빠진 선수 (애런 고든) | 1건 |
| 엘리트 파울 드로어 | 역대급 파울 유도 선수를 일반 규칙으로 하향 (하든) | 1건 |

### 5.2 Phase 2 수동 교정 (22건)

| # | 선수 | 주요 교정 | 사유 |
|---|------|-----------|------|
| 1 | 촌시 빌럽스 | intangibles 78→92, siq 82→88 | 이름 불일치 + 파이널 MVP |
| 2 | 타이리스 맥시 | intangibles 78→88, siq 83→88 | CHAMPIONS 누락, 2024 챔피언 |
| 3 | 파우 가솔 | intangibles 80→88, siq 80→85 | CHAMPIONS 누락, 2x 챔피언 |
| 4 | 빌 러셀 | siq 84→95, hus 91→96 | 11x 챔피언, proxyOVR 낮지만 IQ 역대급 |
| 5 | 케빈 가넷 | siq 87→92 | MVP + 챔피언, 양방향 빅맨 |
| 6 | 더크 노비츠키 | mid 84→92, siq 82→88 | 역대 최고 미드레인지 슈터 |
| 7 | 조지 거빈 | mid 87→93, close 85→92, siq 82→88 | "The Iceman" 역대급 스코어러 |
| 8 | 레이 앨런 | siq 82→88 | 2x 챔피언, 효율적 슈터 |
| 9 | 토니 파커 | siq 80→86 | 4x 챔피언, 파이널 MVP |
| 10 | 크리스 폴 | siq 80→90, intangibles 78→85 | 올타임 어시스트 리더 |
| 11 | 스티브 내쉬 | siq 80→90, intangibles 72→88 | 2x MVP |
| 12 | 레지 밀러 | intangibles 72→88, siq 82→88 | 역대급 클러치 슈터 |
| 13 | 카이리 어빙 | mid 86→95, lay 89→95 | 역대급 피니셔, 2016 챔피언 |
| 14 | 더마 드로잔 | close 88→93 | 미드레인지/클로즈 전문가 |
| 15 | 데릭 로즈 | lay 87→92 | MVP, 엘리트 피니셔 |
| 16 | 제일런 브런슨 | close 86→90, lay 90→93, siq 80→86 | 24-25 올스타, TS% 59% |
| 17 | 칼-앤서니 타운스 | 3c/3_45/3t 72→84 | 역대 최고 슈팅 센터, 3PT% 39.8% |
| 18 | 쳇 홈그렌 | 3c/3_45/3t 71→80 | 현대 스트레치 빅, 3PT% 37.5% |
| 19 | 폴 조지 | 3c/3_45/3t 72→84 | SF/PF 윙, 3PT% ~38% |
| 20 | 앤드류 위긴스 | 3c/3_45/3t 70→78 | SF/PF 윙, 3PT% ~35% |
| 21 | 제임스 하든 | draw 86→95 | NBA 역사상 최고의 파울 유도 (FTr 0.40+) |
| 22 | 애런 고든 | pdef 74→82 | 뛰어난 스위치 수비수, 목록 누락 |

### 5.3 Phase 3+4 수동 교정 (5건)

| # | 선수 | 주요 교정 | 사유 |
|---|------|-----------|------|
| 1 | 라우리 마카넨 | 3c/3_45/3t 70→82 | 이름 불일치 ("마카넨"/"마르카넨") |
| 2 | 벤 월리스 | siq 80→85, hus 91→97 | 4x DPOY, 수비/허슬 레전드 |
| 3 | 크리스 미들턴 | mid 86→93 | 엘리트 미드레인지, 2021 챔피언 |
| 4 | 클레이 탐슨 | intangibles 75→85, siq 77→85 | 이름 불일치 ("탐슨"/"톰슨"), 4x 챔피언 |
| 5 | 알 호포드 | 3c/3_45/3t 66→72 | 스트레치 5, 2024 챔피언 |

---

## 6. 능력치 평가 기준점

### 등급 스케일

| 등급 | 범위 | 의미 | 해당 선수 수 |
|------|------|------|-------------|
| 역대급 | 97-99 | NBA 역사상 Top 1-3 | 극소수 (1-3명/스킬) |
| 엘리트 | 93-96 | 현역 상위 1% | 5-10명 |
| 올스타 | 88-92 | 상위 5% | 15-25명 |
| 우수 선발 | 83-87 | 상위 15% | 30-50명 |
| 리그 평균 | 73-82 | 선발급 | ~200명 |
| 로테이션 | 63-72 | 벤치 상위 | ~200명 |
| 벤치 | 50-62 | 말단 | ~100명 |
| 심각한 약점 | 40-49 | 해당 스킬 극히 부족 | 상황별 |

### 특수 규칙: ft (자유투)

엔진이 `ft/100`을 FT 확률로 직접 사용하므로 실제 FT%와 근접 매핑 필수:

| 실제 FT% | ft 값 |
|----------|-------|
| 90%+ | 92-99 |
| 80-89% | 80-91 |
| 70-79% | 68-79 |
| 60-69% | 55-67 |
| < 60% | 35-54 |

### intangibles — 5-Factor 모델

| 요소 | 비중 | 평가 기준 |
|------|------|----------|
| 클러치 퍼포먼스 | 30% | 잔여 5분/5점차 내 슈팅, 게임 위너 |
| 리더십 | 25% | 플레이오프 성과, 팀 승률 기여 |
| 압박하 침착성 | 20% | 플레이오프 TOV%, 파울 트러블 |
| 빅 게임 이력 | 15% | 플레이오프 vs 레귤러시즌 스탯 델타 |
| 경쟁 의지 | 10% | 빅 게임 허슬 증가량 |

기준점: 99=MJ/르브론, 95=코비/카와이, 90=데임/지미, 85=흔들리지 않는 선발, 75=평균

### dur — 4-Factor 모델

| 요소 | 비중 | 데이터 |
|------|------|--------|
| 출장 일관성 | 40% | 최근 3시즌 GP 평균 / 가능 경기 수 |
| 부상 심각도 | 30% | ACL/아킬레스 등 대형 부상 횟수 |
| 체형 내구성 | 15% | 키/몸무게 비율, 빌드 타입 |
| 나이 대비 회복력 | 15% | 최근 GP 추세 |

---

## 7. 최종 산출물

### SQL 파일 (적용 순서)

| 순서 | 파일 | Phase | 내용 |
|------|------|-------|------|
| 1 | `scripts/sql/insert_missing_players.sql` | 1 | 누락 5명 INSERT |
| 2 | `scripts/sql/update_anchor_28.sql` | 1 | 앵커 28명 UPDATE |
| 3 | `scripts/sql/update_phase2_starters.sql` | 2 | 선발 94명 자동 보정 |
| 4 | `scripts/sql/update_phase2_overrides.sql` | 2 | 22건 수동 교정 |
| 5 | `scripts/sql/update_phase34_rest.sql` | 3+4 | 나머지 276명 자동 보정 |
| 6 | `scripts/sql/update_phase34_overrides.sql` | 3+4 | 5건 수동 교정 |

모든 UPDATE는 `base_attributes || '{...}'::jsonb` 패턴으로 키 단위 부분 업데이트. 같은 키에 대해 나중 SQL이 이전을 덮어쓰므로 순서대로 적용하면 됨.

### Python 스크립트

| 파일 | 용도 |
|------|------|
| `scripts/generate_phase2_updates.py` | Phase 2 자동 보정 SQL 생성 (MIN_OVR=72) |
| `scripts/generate_phase34_updates.py` | Phase 3+4 자동 보정 SQL 생성 (MIN_OVR 없음) |

---

## 8. 커버리지 요약

| 구분 | Phase 1 (수동) | Phase 2 (자동+수동) | Phase 3+4 (자동+수동) | 변경 없음 | 총계 |
|------|---------------|--------------------|-----------------------|-----------|------|
| 선수 수 | 33명 | 94+22명 | 276+5명 | 234명 | 632명 |
| 방식 | 웹 검색 + 개별 리뷰 | 규칙 기반 + 오버라이드 | 확장 규칙 + 오버라이드 | 보정 불필요 | - |

"변경 없음" 234명은 자동 보정 규칙 어디에도 해당하지 않는 선수들 — 이미 합리적인 범위에 있거나 CHAMPIONS 등 예외 목록에 의해 보호됨.

---

## 9. 알려진 한계 및 향후 과제

1. **이름 불일치 문제**: CSV 한글 표기와 예외 목록 한글 표기가 다른 경우 발생 (탐슨/톰슨, 마카넨/마르카넨). 수동 교정으로 해결했으나 CSV 원본 통일이 근본 해결책.

2. **Proxy OVR 한계**: 슈팅 능력이 낮은 수비 전문가(벤 월리스 등)의 proxyOVR이 실제 가치보다 낮게 산출되어, 높은 siq/hus가 과도하게 하향됨. 포지션별 가중 proxyOVR 도입을 검토할 수 있음.

3. **규칙 간 상호작용**: 한 선수에게 여러 규칙이 동시 적용되면 누적 하향이 과도할 수 있음. 현재는 수동 교정으로 대응.

4. **Phase 5 시뮬레이션 검증**: 능력치 교정 후 리그 평균(FG% ~47%, 3PT% ~36%, FT% ~78%)과 팀 승수 분포(최강팀 65승, 최약팀 17승 이내) 확인 필요. 사용자가 직접 수행 예정.

5. **아키타입 임계값 재조정**: 능력치 분포가 변경되었으므로 `constants.ts`의 아키타입 임계값을 새 분포에 맞게 재조정 필요 (별도 작업).
