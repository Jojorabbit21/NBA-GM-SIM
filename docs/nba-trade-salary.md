# NBA 트레이드 & 샐러리 캡 전문 지식 베이스

> 이 문서는 NBA-GM-SIM의 현실적인 트레이드 로직 구현을 위한 참고 베이스다.
> 실제 NBA CBA(단체협약) 규칙을 기반으로 하되, 시뮬레이션 맥락에 맞게 재해석한다.
> **중요**: 이 시뮬레이션에서는 드래프트 픽이 트레이드에 포함되지 않는다. 선수만 교환 대상이다.

---

## 1. NBA 샐러리 캡 구조 (2024-25 기준)

### 1-1. 핵심 기준선 (Thresholds)

| 기준선 | 2024-25 금액 | 의미 |
|-------|------------|------|
| **샐러리 캡 (Salary Cap)** | ~$141M | 이 이하이면 "캡 스페이스 팀" |
| **럭셔리 택스 라인 (Luxury Tax)** | ~$171M | 초과 시 사치세 부과 |
| **퍼스트 에이프런 (First Apron)** | ~$178M | 추가 제약 발동 |
| **세컨드 에이프런 (Second Apron)** | ~$189M | 강력한 제약, 사실상 하드캡 |

> 매 시즌 BRI(Basketball Related Income)에 따라 캡이 조정된다.
> 시뮬레이션에서는 단일 시즌이므로 고정값으로 처리해도 무방.

---

### 1-2. 사치세 (Luxury Tax) 구조

럭셔리 택스 라인 초과분에 대해 **구간별 차등 세율** 적용:

| 초과 구간 | 세율 (일반 납세자) | 세율 (반복 납세자) |
|---------|-----------------|-----------------|
| $0 ~ $5M 초과 | $1.50 / $1 | $1.75 / $1 |
| $5M ~ $10M 초과 | $1.75 / $1 | $2.00 / $1 |
| $10M ~ $15M 초과 | $2.50 / $1 | $2.75 / $1 |
| $15M ~ $20M 초과 | $3.25 / $1 | $3.50 / $1 |
| $20M 초과 | $3.75 / $1 | $4.25 / $1 |

**반복 납세자(Repeat Taxpayer)**: 직전 3년 중 2번 이상 사치세 납부 시 적용.

#### 사치세의 의미
- 소규모 시장 팀에게 세금 수익 배분 → 리그 균형 유지 장치
- 캡 초과 팀도 선수 영입/트레이드 가능하지만 경제적 부담이 커짐
- 오너(구단주) 입장에서 사치세 = 실제 손실 → GM이 캡 효율 중시하는 이유

---

### 1-3. 에이프런 제약 (Apron Restrictions)

#### 퍼스트 에이프런 ($178M)
- Mid-Level Exception 사용 불가 (풀 MLE 사용 시 에이프런 초과 금지)
- Bi-Annual Exception 사용 불가
- Trade Exception(TPE) 사용 제한

#### 세컨드 에이프런 ($189M)
가장 강력한 제약. 실질적으로 로스터 개선이 거의 불가능해짐:
- **샐러리 집계 트레이드(Salary Aggregation) 불가**: 작은 계약 여러 개를 합쳐서 큰 계약과 트레이드하는 방식 금지
- **Trade Exception 사용 불가**: 기존에 적립된 TPE도 사용 못 함
- **Veteran Minimum 이상의 Free Agent 영입 제한**
- **바이아웃 선수 영입 제한**: 그 시즌 $1,600만 이상 계약 선수 불가
- 이 구간 팀은 사실상 현재 로스터로만 경쟁해야 함

> **시뮬레이션 적용**: 에이프런은 CPU 팀의 FA/트레이드 적극성에 영향. 세컨드 에이프런 팀은 트레이드 제안 능력 제한.

---

### 1-4. 샐러리 예외 조항 (Salary Exceptions)

#### 주요 예외 조항
| 예외 조항 | 금액(2024-25) | 사용 조건 | 비고 |
|---------|------------|---------|------|
| **Full Mid-Level Exception (MLE)** | ~$12.8M | 럭셔리 택스 미납 팀 | 최대 4년 |
| **Taxpayer MLE** | ~$5.0M | 럭셔리 택스 납부 팀 | 최대 3년 |
| **Bi-Annual Exception** | ~$4.5M | 럭셔리 택스 미납 팀 | 2년마다 사용 가능 |
| **Room Exception** | ~$7.9M | 캡 스페이스 팀 전용 | 캡 스페이스 다 쓴 후 |
| **Veteran Minimum** | 경력 연수별 차등 | 항상 사용 가능 | 최소 계약 |

#### Trade Exception (TPE)
- 트레이드 시 내보낸 선수보다 **적은 금액**을 받을 때 생성
- 생성된 차액만큼 FA 영입이나 트레이드에 사용 가능 (유효기간 1년)
- 예: $20M 선수 트레이드 후 $15M만 받으면 $5M TPE 생성
- **세컨드 에이프런 팀은 사용 불가**

---

## 2. NBA 트레이드 규칙 (CBA 기반)

### 2-1. 샐러리 매칭 (Salary Matching)

트레이드의 핵심 규칙. 캡 초과 팀은 내보내는 금액에 맞는 샐러리만 받을 수 있다.

#### 기본 매칭 공식 (2023 CBA 기준)

| 내보내는 샐러리 | 받을 수 있는 최대 샐러리 |
|-------------|-------------------|
| **$0 ~ $7.5M** | 내보내는 금액 + $100K (또는 150%까지, 둘 중 큰 값) |
| **$7.5M 초과** | 내보내는 금액의 **125% + $100K** |

**예시**:
- $15M 선수를 트레이드 → 최대 $18.85M (`$15M × 125% + $100K`) 까지 받을 수 있음
- $30M 선수 트레이드 → 최대 $37.6M 까지 받을 수 있음

#### 캡 스페이스 팀의 예외
- 캡 아래 팀은 매칭 없이 남은 캡 스페이스 한도 내에서 자유롭게 트레이드 가능
- 보통 리빌딩 팀들이 나쁜 계약을 받아오는 이유

---

### 2-2. 트레이드 제한 규칙

#### 타이밍 제한
- **신규 계약 선수**: 계약 후 최소 **3개월** 또는 시즌 시작 후 30일까지 트레이드 불가
- **Sign-and-Trade 선수**: 계약 직후 즉시 이적
- **트레이드 데드라인**: 시즌 중반 (보통 2월 초순) 이후 트레이드 금지

#### No-Trade Clause (NTC, 노트레이드 조항)
- 특정 베테랑 선수들은 계약서에 NTC 포함 가능
- 선수 동의 없으면 트레이드 불가
- 실제로는 선수들이 목적지를 선택하거나 트레이드를 거부할 수 있음
- **시뮬레이션**: OVR 90+ 스타 선수에게 NTC 부여 고려 (선수 의사 반영)

#### Three-Team Trade (3자 트레이드)
- 2팀 간 직접 매칭이 안 될 때 제3팀을 매개로 활용
- 매칭 규칙은 각 팀의 순 내보내기/받기 기준으로 계산
- **시뮬레이션**: 구현 복잡도 ↑ → 초기에는 2팀 트레이드만 구현 권장

---

### 2-3. 선수 계약 유형

#### 계약 구조
| 유형 | 설명 | 시뮬레이션 영향 |
|-----|------|------------|
| **Max Contract** | 최고 연봉 계약 (경력별 25~35%) | 에이스 선수들의 기준 계약 |
| **Supermax** | 현 소속팀 재계약 시 추가 5% | 팀에서 오래 뛴 스타 보유 유리 |
| **Veteran Extension** | 시즌 중 계약 연장 | 트레이드 시 이 선수는 바이아웃 가능성 |
| **Rookie Contract** | 드래프트 후 4년 계약 | 저렴한 샐러리 + 높은 퍼포먼스 = 트레이드 가치 高 |
| **Two-Way Contract** | G리그 포함 최소 계약 | 경쟁력 있는 벤치 선수 저렴하게 확보 |
| **Minimum Contract** | 리그 최저 계약 | 베테랑 바이아웃 후 영입 시 |

---

## 3. 선수 트레이드 가치 산정 (Trade Value)

> **핵심 원칙**: 트레이드 가치는 단순 OVR이 아니다. **OVR × 샐러리 효율 × 나이 × 역할 희소성 × 계약 조건**의 복합 함수다.

### 3-1. 가치 산정 5요소

#### ① OVR (퍼포먼스 가치)
가장 기본적인 선수 능력치 지표.

| OVR 범위 | 등급 | 트레이드 시장 위치 |
|---------|------|----------------|
| 90+ | 프랜차이즈 스타 | 패키지 없이 1:1 트레이드 불가 |
| 85~89 | 올스타 레벨 | 에이스 트레이드의 핵심 주전 |
| 80~84 | 로테이션 에이스 | 좋은 역할 선수 여럿과 교환 |
| 75~79 | 가치 있는 로테이션 선수 | 직접 교환 가능 레벨 |
| 70~74 | 로테이션 벤치 | 샐러리 매칭 목적 포함 |
| 70 미만 | 최저 로테이션 | 샐러리 패더(filler) 역할 |

#### ② 샐러리 효율 (Contract Value)
**실제 퍼포먼스 vs 받는 돈의 비율**이 핵심.

```
샐러리 효율 = OVR / (연봉 / 1M)
```

| 효율 수치 | 의미 | 트레이드 적극성 |
|---------|-----|-------------|
| 10+ | 극단적 가성비 (루키 등) | 모든 팀이 원함 |
| 7~10 | 좋은 가성비 | 트레이드 시 부가 가치 |
| 5~7 | 적정 가치 | 공정 교환 |
| 3~5 | 약간 비효율 | 받는 팀에 약간의 손해 |
| 3 미만 | 나쁜 계약 | 트레이드 성사 어려움 |

**예시**:
- OVR 78, 연봉 $5M → 효율 15.6 (루키 수준 가성비, 극도로 가치 있음)
- OVR 85, 연봉 $30M → 효율 2.8 (나쁜 계약, 트레이드 시 손해 감수해야 함)
- OVR 80, 연봉 $15M → 효율 5.3 (공정한 가치)

#### ③ 나이 & 성장 잠재력

| 나이 | 트레이드 가치 보정 |
|-----|---------------|
| 22세 이하 | +20~30% (성장 가능성) |
| 23~25세 | +10~15% (전성기 진입) |
| 26~28세 | ±0% (전성기, 기준값) |
| 29~30세 | -5~10% (하락 시작) |
| 31~33세 | -15~25% (노쇠화 리스크) |
| 34세 이상 | -30%+ (계약 말년 위험) |

**역방향 활용**: 리빌딩 팀은 젊은 선수를 과대평가해서 받는 경향.
윈나우 팀은 33세 MVP보다 28세 80 OVR 선수를 선호.

#### ④ 역할 희소성 (Position Scarcity)

시장에서 구하기 어려운 포지션/역할은 트레이드 가치가 프리미엄:

| 역할 | 희소성 등급 | 이유 |
|-----|---------|-----|
| Elite PG (85+) | ★★★★★ | 가장 구하기 어려운 포지션 |
| Rim Protector (85+) | ★★★★ | 수비 빅맨 부족 |
| 3-and-D Wing | ★★★★ | 모든 팀이 필요 |
| Stretch C (75+) | ★★★ | 현대 농구 필수 |
| Scoring SF (80+) | ★★★ | 비교적 많음 |
| Bench Scorer | ★★ | 리그에 많음 |
| Pure Backup C | ★ | 가장 구하기 쉬움 |

#### ⑤ 계약 남은 기간 & 조건

| 계약 상태 | 트레이드 가치 영향 |
|---------|----------------|
| **루키 계약** (1~2년 남음) | +30%+ (저렴하고 곧 연장 가능) |
| **3~4년 남음** | 기준값 (안정적인 계약) |
| **Expiring (만료 임박)** | ±0 (재계약 협상 필요) 또는 -10% (불확실성) |
| **나쁜 장기 계약** (5년 이상 + 비효율) | -20~50% (데드머니 리스크) |

---

### 3-2. 종합 트레이드 가치 공식 (시뮬레이션 구현용)

```typescript
function calculateTradeValue(player: Player): number {
    // 기본 OVR 기반 가치 (지수 곡선: 스타일수록 가치 폭발)
    const ovrValue = Math.pow(player.ovr / 75, 2.5) * 100;

    // 샐러리 효율 보정
    const salaryEfficiency = player.ovr / (player.salary / 1_000_000);
    const contractMult = Math.min(2.0, Math.max(0.4, salaryEfficiency / 6));

    // 나이 보정
    const ageMult = calculateAgeMult(player.age);

    // 역할 희소성 보정
    const scarcityMult = calculateScarcityMult(player.archetype, player.ovr);

    return ovrValue * contractMult * ageMult * scarcityMult;
}

function calculateAgeMult(age: number): number {
    if (age <= 22) return 1.25;
    if (age <= 25) return 1.12;
    if (age <= 28) return 1.00;
    if (age <= 30) return 0.92;
    if (age <= 33) return 0.80;
    return 0.65;
}

function calculateScarcityMult(archetype: string, ovr: number): number {
    const premiumArchetypes = ['Handler', 'Rim Protector', 'TwoWay'];
    const standardArchetypes = ['Spacer', 'Stretch', 'Lockdown'];

    if (premiumArchetypes.includes(archetype) && ovr >= 82) return 1.20;
    if (standardArchetypes.includes(archetype) && ovr >= 78) return 1.10;
    return 1.00;
}
```

---

## 4. 실제 NBA 트레이드가 일어나는 방식

### 4-1. 트레이드 동기 유형

#### A. 윈나우 팀 (Contender) 의 동기
- 현재 전력 강화: 역할 부재 포지션 채우기
- 플레이오프 직전 보강: 3-and-D 윙, 클러치 플레이어
- **기꺼이 하는 것**: 나쁜 계약 + 리빌딩 팀의 에이스 = 즉전력 확보
- **꺼리는 것**: 미래(나이 많은 선수, 나쁜 계약 떠안기)
- **예시**: 데드라인 전 포인트 포워드 또는 수비 전문가 확보

#### B. 리빌딩 팀 (Rebuilder) 의 동기
- 젊은 선수 & 가성비 계약 확보
- 나쁜 베테랑 계약 처분 (데드머니 청산)
- 미래 전력 강화
- **기꺼이 하는 것**: 나이 많은 스타 + 나쁜 계약 받기 (대신 젊은 선수 얻기)
- **꺼리는 것**: 노린 어린 선수를 뺏기는 트레이드
- **예시**: 33세 스타를 받고 26세 80 OVR 선수 내주기는 NO

#### C. 중위권 팀 (Middle Tier) 의 동기
- 포지션 밸런스 맞추기
- 가성비 개선 (비효율 계약 처분 + 효율 계약 확보)
- 플레이오프 시드 개선

---

### 4-2. 공정한 트레이드 성립 조건

트레이드가 성사되려면 **양팀 모두** "이 트레이드가 우리에게 이득"이라고 판단해야 한다.

#### 핵심 원칙: 양팀의 니즈가 맞아야 한다

**같은 선수도 상황에 따라 다르게 평가됨:**

예시) OVR 82, 28세, 연봉 $20M, 포지션 SF

| 팀 유형 | 이 선수에 대한 평가 |
|---------|----------------|
| 윈나우 팀 (SF 약점) | 과대평가 → 큰 대가 지불 의향 |
| 윈나우 팀 (SF 충분) | 저평가 → 관심 없음 |
| 리빌딩 팀 | 나이가 문제, 관심 낮음 |
| 중위권 (SF 약점) | 공정 평가, 협상 가능 |

---

### 4-3. 실제 트레이드 프로세스 (NBA)

```
1. GM 간 비공개 연락 (의향 타진)
2. 상대 팀이 원하는 선수 패키지 제안
3. 역제안 (Counter-offer)
4. 협상 (3~4번 왕복 일반적)
5. 양 팀 오너 최종 승인
6. 리그 오피스 승인 (CBA 규정 준수 확인)
7. 선수 의료 검진 (트레이드 거부 가능)
8. 공식 발표
```

#### 시뮬레이션에서의 트레이드 프로세스
```
1. 유저가 트레이드 제안 생성
2. CPU 팀이 제안 평가 (수락/거부/역제안)
3. 역제안 협상 (최대 2~3회)
4. 샐러리 매칭 검증
5. 양팀 로스터 업데이트
```

---

## 5. CPU 팀 트레이드 AI 로직 설계 (시뮬레이션)

> 현재 `api/trade-engine.ts`는 stub(10% 랜덤 수락). 아래가 실제 구현 청사진이다.

### 5-1. CPU 트레이드 제안 평가 로직

```typescript
interface TradeEvaluation {
    accept: boolean;
    counterOffer?: TradeOffer;
    reason: string;
    valueDiff: number; // 양수 = CPU에게 유리, 음수 = CPU에게 불리
}

function evaluateTrade(
    cpuTeam: Team,
    offer: TradeOffer, // 유저가 내보내는 선수들
    request: TradeOffer, // 유저가 받으려는 선수들
): TradeEvaluation {

    // 1. 가치 계산
    const offeredValue = offer.players.reduce((sum, p) => sum + calculateTradeValue(p), 0);
    const requestedValue = request.players.reduce((sum, p) => sum + calculateTradeValue(p), 0);
    const valueDiff = requestedValue - offeredValue; // CPU 관점: 양수 = 좋음

    // 2. 샐러리 매칭 검증
    if (!isSalaryMatchValid(cpuTeam, offer, request)) {
        return { accept: false, reason: 'salary_mismatch', valueDiff };
    }

    // 3. 팀 니즈 분석
    const needScore = analyzeTeamNeed(cpuTeam, offer.players, request.players);

    // 4. 가치 + 니즈 종합 판단
    const adjustedDiff = valueDiff + needScore; // 포지션 필요하면 손해 감수

    // CPU는 자신에게 유리할 때 수락
    if (adjustedDiff > 0) {
        return { accept: true, reason: 'favorable', valueDiff };
    }

    // 약간 불리해도 포지션 필요하면 역제안
    if (adjustedDiff > -15) {
        const counter = generateCounterOffer(cpuTeam, offer, request);
        return { accept: false, counterOffer: counter, reason: 'counter', valueDiff };
    }

    // 크게 불리하면 거부
    return { accept: false, reason: 'unfavorable', valueDiff };
}
```

### 5-2. 팀 니즈 분석

```typescript
function analyzeTeamNeed(
    team: Team,
    incoming: Player[], // CPU가 받는 선수들
    outgoing: Player[], // CPU가 내보내는 선수들
): number {
    let needScore = 0;

    // 약한 포지션에 강한 선수가 오면 보너스
    incoming.forEach(player => {
        const positionDepth = getPositionDepth(team, player.position);
        if (positionDepth < 2) needScore += 20; // 포지션 약함 → 받고 싶음
        if (positionDepth >= 4) needScore -= 10; // 포지션 충분 → 필요 없음
    });

    // 팀 방향성에 따른 선수 가치 조정
    if (team.mode === 'rebuild') {
        // 리빌딩 팀: 젊은 선수 선호
        incoming.forEach(p => {
            if (p.age <= 25) needScore += 15;
            if (p.age >= 32) needScore -= 20;
        });
    } else if (team.mode === 'contend') {
        // 윈나우 팀: 즉전력 선호
        incoming.forEach(p => {
            if (p.ovr >= 80 && p.age <= 30) needScore += 15;
            if (p.age >= 33) needScore -= 10;
        });
    }

    return needScore;
}
```

### 5-3. 팀 모드 분류

| 팀 모드 | 기준 | 트레이드 성향 |
|--------|-----|------------|
| **Contend** | 에이스 OVR 87+ | 즉전력, 윈나우 자원 추구 |
| **Compete** | 에이스 OVR 82~86 | 균형적, 현재+미래 |
| **Rebuild** | 에이스 OVR 81 미만 | 젊은 선수 + 가성비 추구 |

---

## 6. 공정 트레이드 가이드라인

### 6-1. OVR 기반 1 대 1 공정 교환 기준

| 내가 내보내는 선수 | 공정하게 받을 수 있는 선수 |
|----------------|----------------------|
| OVR 90 | OVR 88~90 (1:1 직접) |
| OVR 87 | OVR 84~87 (1:1 가능) |
| OVR 85 | OVR 82~85 (1:1) 또는 OVR 78+75 패키지 |
| OVR 82 | OVR 79~82 (1:1) |
| OVR 78 | OVR 75~78 또는 OVR 72+72 |

> **중요**: OVR 외에 나이, 계약, 포지션 희소성에 따라 ±5 OVR 차이는 공정 교환일 수 있음.

### 6-2. 불공정 트레이드 예시

**유저에게 일방적으로 유리한 제안 (CPU가 거부):**
- OVR 78 선수 + OVR 70 선수 → OVR 88 선수 요청
- 노쇠화 징후 있는 OVR 75 선수 → 젊고 성장 중인 OVR 80 선수

**CPU가 기꺼이 손해를 감수하는 경우 (팀 니즈 충족):**
- OVR 75 선수(SF) → OVR 72 선수(SG): 팀에 SF가 없고 SG가 넘침
- 나쁜 계약($25M/OVR 75) 처분을 위해 약간 손해 감수

---

## 7. 샐러리 캡의 실제 전략적 활용

### 7-1. 캡 스페이스 관리 전략

#### Bird Rights (버드 라이트)
- 같은 팀에서 3년 이상 뛴 선수는 초과 캡 상태에서도 재계약 가능
- 최고액(Max) 재계약 가능
- **실전 의미**: 스타를 오래 보유하면 재계약에 유리

#### 캡 홀드 (Cap Hold)
- FA 선수가 팀 내에 있으면 그 선수의 예상 계약액이 캡에 잡혀 있음
- FA 협상 중인 선수를 빼고 다른 선수 먼저 영입 가능

#### 캡 스트래티지 (Dump 전략)
- 나쁜 계약을 다른 팀에 넘기는 대신 추가 자산 제공
- 리빌딩 팀에게 나쁜 계약 + 좋은 가성비 선수를 함께 이전
- 예: "$30M/3년 OVR 72 선수" + OVR 76 선수를 패키지로 트레이드 → 리빌딩 팀 OVR 82 선수 받기

### 7-2. 트레이드 데드라인 전략

**데드라인 전 강팀의 전략:**
- "missing piece" 확보: 3-and-D 윙, 백업 빅맨
- 리빌딩 팀의 에이스를 데드라인에 저렴하게 영입

**데드라인 전 리빌딩 팀의 전략:**
- 만료 예정 베테랑 처분 → 젊은 선수 확보
- "팔자"(Sell): 에이스도 팔아서 리빌딩 가속

**데드라인 후:**
- FA 시장 활용 (바이아웃 선수 영입)
- 리빌딩 팀이 베테랑 바이아웃(계약 해지) 후 윈나우 팀과 계약

---

## 8. 시뮬레이션 트레이드 시스템 구현 체크리스트

### 필수 구현 요소
- [ ] 선수별 `salary` 필드 및 `contractYears` 필드
- [ ] 샐러리 매칭 검증 함수 (125% 룰)
- [ ] 선수 TradeValue 계산 (OVR + 나이 + 계약 + 희소성)
- [ ] 팀별 전체 페이롤 계산 (현재 vs 럭셔리 택스 라인)
- [ ] CPU 팀 트레이드 평가 AI (팀 니즈 + 가치 계산)
- [ ] 역제안(Counter-offer) 생성 로직
- [ ] 트레이드 데드라인 날짜 체크

### 선택 구현 요소 (심화)
- [ ] 에이프런 제약 시뮬레이션
- [ ] 버드 라이트 재계약 로직
- [ ] 바이아웃 선수 FA 영입
- [ ] 3자 트레이드

### 현재 시뮬레이션 미구현 사항 (확인용)
- `api/trade-engine.ts`: Stub 상태 (10% 랜덤) → 위 AI 로직으로 교체 필요
- 선수 `salary` 필드: meta_players에 없을 수 있음 → 확인 필요
- 팀별 페이롤 계산: 미구현 → saves 구조에 추가 필요

---

## 9. 핵심 요약 (Quick Reference)

### 트레이드 성사 3조건
1. **샐러리 매칭** OK (125% 룰 통과)
2. **양팀 모두** "우리에게 이득" 판단
3. **타이밍** 적합 (트레이드 데드라인 이전)

### 선수 가치 결정 우선순위
```
1순위: 샐러리 효율 (가성비)
2순위: OVR 절대값
3순위: 나이 (미래 가치)
4순위: 포지션 희소성
5순위: 현재 팀의 포지션 필요도
```

### CPU 트레이드 수락 기준 (단순화)
```
내가 받는 가치 > 내가 주는 가치 × 1.0  →  수락
내가 받는 가치 > 내가 주는 가치 × 0.85 →  역제안
내가 받는 가치 < 내가 주는 가치 × 0.85 →  거부
(단, 포지션 니즈 매우 높으면 0.80까지 감수)
```
